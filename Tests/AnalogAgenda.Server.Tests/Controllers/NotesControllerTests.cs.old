using AnalogAgenda.Server.Controllers;
using AnalogAgenda.Server.Tests.Helpers;
using Azure.Storage.Blobs;
using Configuration.Sections;
using Database.Data;
using Database.DBObjects.Enums;
using Database.DTOs;
using Database.Entities;
using Database.Services.Interfaces;
using Microsoft.AspNetCore.Mvc;
using Moq;

namespace AnalogAgenda.Server.Tests.Controllers;

public class NotesControllerTests : IDisposable
{
    private readonly Mock<IDatabaseService> _mockTableService;
    private readonly Mock<IBlobService> _mockBlobService;
    private readonly Mock<BlobContainerClient> _mockContainerClient;
    private readonly Storage _storageConfig;
    private readonly AnalogAgendaDbContext _dbContext;
    private readonly NotesController _controller;

    public NotesControllerTests()
    {
        _mockTableService = new Mock<IDatabaseService>();
        _mockBlobService = new Mock<IBlobService>();
        _mockContainerClient = new Mock<BlobContainerClient>();
        _storageConfig = new Storage { AccountName = "teststorage" };
        _dbContext = InMemoryDbContextFactory.Create($"NotesTestDb_{Guid.NewGuid()}");
        
        _mockBlobService.Setup(x => x.GetBlobContainer(ContainerName.notes))
                       .Returns(_mockContainerClient.Object);

        _controller = new NotesController(_storageConfig, _mockTableService.Object, _mockBlobService.Object, _dbContext);
    }
    
    public void Dispose()
    {
        _dbContext.Database.EnsureDeleted();
        _dbContext.Dispose();
    }

    [Fact]
    public async Task CreateNewNote_WithValidDto_ReturnsOkWithRowKey()
    {
        // Arrange
        var noteDto = new NoteDto
        {
            Name = "Test Note",
            SideNote = "Test Description",
            ImageBase64 = null!,
            Entries = []
        };

        _mockNotesTableClient.Setup(x => x.AddEntityAsync(It.IsAny<NoteEntity>(), default))
                            .Returns(Task.FromResult(It.IsAny<Azure.Response>()));

        // Act
        var result = await _controller.CreateNewNote(noteDto);

        // Assert
        var createdResult = Assert.IsType<CreatedResult>(result);
        Assert.IsType<NoteDto>(createdResult.Value);
        _mockNotesTableClient.Verify(x => x.AddEntityAsync(It.IsAny<NoteEntity>(), default), Times.Once);
    }

    [Fact]
    public async Task CreateNewNote_WithException_ReturnsUnprocessableEntity()
    {
        // Arrange
        var noteDto = new NoteDto
        {
            Name = "Test Note",
            SideNote = "Test Description",
            ImageBase64 = null!,
            Entries = new List<NoteEntryDto>()
        };

        _mockNotesTableClient.Setup(x => x.AddEntityAsync(It.IsAny<NoteEntity>(), default))
                            .ThrowsAsync(new Exception("Database error"));

        _mockTableService.Setup(x => x.ExistsAsync(It.IsAny<NoteEntity>()))
                        .ReturnsAsync(false);

        // Act
        var result = await _controller.CreateNewNote(noteDto);

        // Assert
        var unprocessableResult = Assert.IsType<UnprocessableEntityObjectResult>(result);
        Assert.Equal("Database error", unprocessableResult.Value);
    }

    [Fact]
    public async Task GetAllNotes_WithoutEntries_ReturnsOkWithNotes()
    {
        // Arrange
        var noteEntities = new List<NoteEntity>
        {
            new NoteEntity
            {
                Name = "Test Note",
                SideNote = "Test Description",
                ImageId = Guid.NewGuid(),
                Id = "test-row-key"
            }
        };

        _mockTableService.Setup(x => x.GetAllAsync<NoteEntity>())
                        .ReturnsAsync(noteEntities);
                        
        var pagedResponse = new PagedResponseDto<NoteEntity>
        {
            Data = noteEntities,
            TotalCount = noteEntities.Count,
            PageSize = 5,
            CurrentPage = 1
        };
        
        _mockTableService.Setup(x => x.GetPagedAsync<NoteEntity>(It.IsAny<int>(), It.IsAny<int>(), It.IsAny<Func<IEnumerable<NoteEntity>, IOrderedEnumerable<NoteEntity>>?>()))
                        .ReturnsAsync(pagedResponse);

        // Act
        var result = await _controller.GetAllNotes(withEntries: false);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var pagedResult = Assert.IsType<PagedResponseDto<NoteDto>>(okResult.Value);
        Assert.Single(pagedResult.Data);
    }

    [Fact]
    public async Task GetAllNotes_WithEntries_ReturnsOkWithNotesAndEntries()
    {
        // Arrange
        var noteEntities = new List<NoteEntity>
        {
            new NoteEntity
            {
                Name = "Test Note",
                SideNote = "Test Description",
                ImageId = Guid.NewGuid(),
                Id = "test-row-key"
            }
        };

        var noteEntryEntities = new List<NoteEntryEntity>
        {
            new NoteEntryEntity
            {
                Details = "Test Entry",
                Time = 1.0,
                Process = "Test Process",
                Film = "Test Film",
                NoteId = "test-row-key"
            }
        };

        _mockTableService.Setup(x => x.GetAllAsync<NoteEntity>())
                        .ReturnsAsync(noteEntities);
                        
        var pagedResponse = new PagedResponseDto<NoteEntity>
        {
            Data = noteEntities,
            TotalCount = noteEntities.Count,
            PageSize = 5,
            CurrentPage = 1
        };
        
        _mockTableService.Setup(x => x.GetPagedAsync<NoteEntity>(It.IsAny<int>(), It.IsAny<int>(), It.IsAny<Func<IEnumerable<NoteEntity>, IOrderedEnumerable<NoteEntity>>?>()))
                        .ReturnsAsync(pagedResponse);

        _mockTableService.Setup(x => x.GetAllAsync<NoteEntryEntity>())
                        .ReturnsAsync(noteEntryEntities);

        // Act
        var result = await _controller.GetAllNotes(withEntries: true);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var pagedResult = Assert.IsType<PagedResponseDto<NoteDto>>(okResult.Value);
        Assert.Single(pagedResult.Data);
    }

    [Fact]
    public async Task GetNoteById_WithExistingNote_ReturnsOkWithNote()
    {
        // Arrange
        var id = "test-row-key";
        var noteEntity = new NoteEntity
        {
            Name = "Test Note",
            SideNote = "Test Description",
            ImageId = Guid.NewGuid(),
            Id = id
        };

        var noteEntryEntities = new List<NoteEntryEntity>
        {
            new NoteEntryEntity
            {
                Details = "Test Entry",
                Time = 1.0,
                Process = "Test Process",
                Film = "Test Film",
                NoteId = id
            }
        };

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync(noteEntity);

        _mockTableService.Setup(x => x.GetAllAsync<NoteEntryEntity>(It.IsAny<System.Linq.Expressions.Expression<Func<NoteEntryEntity, bool>>>()))
                        .ReturnsAsync(noteEntryEntities);

        // Act
        var result = await _controller.GetNoteById(id);

        // Assert
        var okResult = Assert.IsType<OkObjectResult>(result);
        var note = Assert.IsType<NoteDto>(okResult.Value);
        Assert.NotNull(note.RowKey);  // RowKey is auto-generated
    }

    [Fact]
    public async Task GetNoteById_WithNonExistingNote_ReturnsNotFound()
    {
        // Arrange
        var id = "non-existing-key";

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync((NoteEntity?)null);

        // Act
        var result = await _controller.GetNoteById(id);

        // Assert
        var notFoundResult = Assert.IsType<NotFoundObjectResult>(result);
        Assert.Contains(id, notFoundResult.Value?.ToString() ?? "");
    }

    [Fact]
    public async Task UpdateNote_WithValidData_ReturnsNoContent()
    {
        // Arrange
        var id = "test-row-key";
        var existingEntity = new NoteEntity
        {
            Name = "Old Title",
            SideNote = "Old Description",
            ImageId = Guid.NewGuid(),
            Id = id,
            CreatedDate = DateTime.UtcNow.AddDays(-1),
            ETag = new Azure.ETag("test-etag")
        };

        var updateDto = new NoteDto
        {
            Name = "New Title",
            SideNote = "New Description",
            ImageBase64 = null!,
            Entries = new List<NoteEntryDto>()
        };

        var existingEntryEntities = new List<NoteEntryEntity>();

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync(existingEntity);

        _mockTableService.Setup(x => x.GetAllAsync<NoteEntryEntity>(It.IsAny<System.Linq.Expressions.Expression<Func<NoteEntryEntity, bool>>>()))
                        .ReturnsAsync(existingEntryEntities);

        _mockNotesTableClient.Setup(x => x.UpdateEntityAsync(
                               It.IsAny<NoteEntity>(), 
                               It.IsAny<Azure.ETag>(), 
                               TableUpdateMode.Replace, 
                               default))
                            .Returns(Task.FromResult(It.IsAny<Azure.Response>()));

        _mockTableService.Setup(x => x.DeleteRangeAsync(It.IsAny<IEnumerable<NoteEntryEntity>>()))
                        .Returns(Task.CompletedTask);

        // Act
        var result = await _controller.UpdateNote(id, updateDto);

        // Assert
        Assert.IsType<NoContentResult>(result);
        _mockNotesTableClient.Verify(x => x.UpdateEntityAsync(
            It.IsAny<NoteEntity>(), 
            existingEntity.ETag, 
            TableUpdateMode.Replace, 
            default), Times.Once);
    }

    [Fact]
    public async Task UpdateNote_WithNullDto_ReturnsBadRequest()
    {
        // Arrange
        var id = "test-row-key";

        // Act
        var result = await _controller.UpdateNote(id, null!);

        // Assert
        var badRequestResult = Assert.IsType<BadRequestObjectResult>(result);
        Assert.Equal("Invalid data.", badRequestResult.Value);
    }

    [Fact]
    public async Task UpdateNote_WithNonExistingNote_ReturnsNotFound()
    {
        // Arrange
        var id = "non-existing-key";
        var updateDto = new NoteDto
        {
            Name = "New Title",
            SideNote = "New Description",
            Entries = new List<NoteEntryDto>()
        };

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync((NoteEntity?)null);

        // Act
        var result = await _controller.UpdateNote(id, updateDto);

        // Assert
        Assert.IsType<NotFoundResult>(result);
    }

    [Fact]
    public async Task DeleteNote_WithExistingNote_ReturnsNoContent()
    {
        // Arrange
        var id = "test-row-key";
        var existingEntity = new NoteEntity
        {
            Name = "Test Note",
            SideNote = "Test Description",
            ImageId = Guid.NewGuid(),
            Id = id
        };

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync(existingEntity);

        _mockTableService.Setup(x => x.DeleteRangeAsync<NoteEntryEntity>(It.IsAny<System.Linq.Expressions.Expression<Func<NoteEntryEntity, bool>>>()))
                        .Returns(Task.CompletedTask);

        // Act
        var result = await _controller.DeleteNote(id);

        // Assert
        Assert.IsType<NoContentResult>(result);
        // Note: DeleteEntityWithImageAsync from base controller handles the note deletion internally
        _mockTableService.Verify(x => x.DeleteRangeAsync<NoteEntryEntity>(It.IsAny<System.Linq.Expressions.Expression<Func<NoteEntryEntity, bool>>>()), Times.Once);
        _mockTableService.Verify(x => x.GetByIdAsync<NoteEntity>(id), Times.Once);
    }

    [Fact]
    public async Task DeleteNote_WithNonExistingNote_ReturnsNotFound()
    {
        // Arrange
        var id = "non-existing-key";

        _mockTableService.Setup(x => x.GetByIdAsync<NoteEntity>(id))
                        .ReturnsAsync((NoteEntity?)null);

        // Act
        var result = await _controller.DeleteNote(id);

        // Assert
        Assert.IsType<NotFoundResult>(result);
    }
}
