<div class="container">
  <div class="box">
    <form [formGroup]="formGroup" (ngSubmit)="submit()" class="form">
      <h1 class="form-title" *ngIf="!isEditMode;else is_update">Add New Session</h1>
      <ng-template #is_update>
        <h1 class="form-title">Edit Session</h1>
      </ng-template>

      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>

      <div *ngIf="successMessage" class="success-message">
        {{ successMessage }}
      </div>

      <div>
        <label for="sessionDate">Session Date</label>
        <input type="date" id="sessionDate" formControlName="sessionDate" class="input" />
        <div *ngIf="formGroup.get('sessionDate')?.invalid && formGroup.get('sessionDate')?.touched" class="error">
          Session date is required.
        </div>
      </div>

      <div>
        <label for="location">Location</label>
        <input type="text" id="location" formControlName="location" class="input" 
               placeholder="Enter session location" />
        <div *ngIf="formGroup.get('location')?.invalid && formGroup.get('location')?.touched" class="error">
          Location is required.
        </div>
      </div>

      <div>
        <label for="description">Description</label>
        <textarea id="description" formControlName="description" class="input" 
                  rows="3" placeholder="Optional description of the session"></textarea>
      </div>

      <div>
        <label>Session Photo</label>
        <input type="file" accept="image/*" (change)="onFileSelected($event)" class="input" />
        <div *ngIf="imagePreview" class="image-preview">
          <img [src]="imagePreview" alt="Session preview" />
        </div>
      </div>

      <div>
        <label>Participants</label>
        <div class="checkbox-group">
          <label *ngFor="let participant of participantOptions" class="checkbox-label">
            <input type="checkbox" 
                   [checked]="isParticipantSelected(participant)"
                   (change)="onParticipantChange(participant, $event)" />
            <span>{{participant}}</span>
          </label>
        </div>
        <div *ngIf="selectedParticipants.length === 0" class="error error-centered">
          At least one participant is required.
        </div>
      </div>

      <div>
        <label>Used Substances</label>
        <div class="checkbox-option">
          <label class="checkbox-label">
            <span>Show expired dev kits</span>
            <input type="checkbox" [(ngModel)]="showExpiredDevKits" [ngModelOptions]="{standalone: true}" />
          </label>
        </div>
        
        <div class="items-grid">
          <div *ngFor="let devKit of filteredDevKits" class="item-card" 
               [class.selected]="isDevKitSelected(devKit.rowKey)"
               [class.expired]="devKit.expired"
               (click)="toggleDevKit(devKit.rowKey)">
            <div class="item-content">
              <div class="item-info">
                <img [src]="devKit.imageUrl" alt="{{devKit.name}}" class="item-image" />
                <div class="item-details">
                  <span class="item-name">{{devKit.name}}</span>
                  <span class="item-type">{{devKit.type}}</span>
                  <span class="item-status" *ngIf="devKit.expired">EXPIRED</span>
                </div>
              </div>
            </div>
            <div class="item-checkbox">
              <input type="checkbox" 
                     [checked]="isDevKitSelected(devKit.rowKey)"
                     readonly />
            </div>
          </div>
        </div>
      </div>

      <div>
        <label>Films Developed</label>
        <div class="items-grid">
          <div *ngFor="let film of availableFilms" class="item-card" 
               [class.selected]="isFilmSelected(film.rowKey)"
               (click)="toggleFilm(film.rowKey)">
            <div class="item-content">
              <div class="item-info">
                <img [src]="film.imageUrl" alt="{{film.name}}" class="item-image" />
                <div class="item-details">
                  <span class="item-name">{{film.name}}</span>
                  <span class="item-type">{{film.type}} - ISO {{film.iso}}</span>
                  <span class="item-owner">{{film.purchasedBy}}</span>
                </div>
              </div>
            </div>
            <div class="item-checkbox">
              <input type="checkbox" 
                     [checked]="isFilmSelected(film.rowKey)"
                     readonly />
            </div>
          </div>
        </div>
      </div>

      <button type="submit" [disabled]="formGroup.invalid || loading" class="submit-btn">
        <span *ngIf="!loading">Save</span>
        <svg *ngIf="loading" class="spinner" viewBox="0 0 24 24">
          <circle class="spinner-bg" cx="12" cy="12" r="10" stroke-width="4"></circle>
          <path class="spinner-path" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
      </button>
    </form>

    <!-- Delete Button -->
    <button *ngIf="isEditMode" class="delete-btn" (click)="isDeleteModalOpen = true">Delete</button>

    <div class="delete-modal-overlay" *ngIf="isDeleteModalOpen" (click)="isDeleteModalOpen = false">
      <div class="delete-modal" (click)="$event.stopPropagation()">
        <h2>Confirm Delete</h2>
        <p>
          Are you sure you want to delete this session at <strong>{{ form.get('location')?.value }}</strong>?
        </p>
        <div class="delete-modal-actions">
          <button class="cancel-btn" (click)="isDeleteModalOpen = false">Cancel</button>
          <button class="delete-btn" (click)="onDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>
