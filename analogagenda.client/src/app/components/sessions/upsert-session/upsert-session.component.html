<div class="session-management-container" *ngIf="!loading">
  <!-- Header -->
  <div class="header">
    <div class="header-info">
      <h2>{{ isInsert ? 'New Session' : (isViewMode ? 'Session Details' : 'Edit Session') }}</h2>
      <div class="session-details" *ngIf="currentItem">
        <span class="location">{{ currentItem.location || 'No location set' }}</span>
        <span class="date">{{ currentItem.sessionDate | date:'mediumDate' }}</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="primary-actions">
        <button *ngIf="!isInsert && isEditMode" class="btn btn-danger" (click)="isDeleteModalOpen = true">
          Delete Session
        </button>
        <button *ngIf="isEditMode || isInsert" class="btn btn-primary" (click)="submit()" [disabled]="loading">
          {{ loading ? 'Saving...' : 'Save Session' }}
        </button>
      </div>
      <div class="secondary-actions">
        <button *ngIf="currentItem.imageUrl" class="btn btn-secondary session-image-btn" (click)="showSessionImageModal = true">
          <span *ngIf="isViewMode">View Image</span>
          <span *ngIf="!isViewMode">Change Image</span>
        </button>
        <button *ngIf="!isInsert" class="btn btn-secondary" (click)="toggleEditMode()">
          {{ isEditMode ? 'View Mode' : 'Edit Mode' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>
  <div class="alert alert-error" *ngIf="errorMessage">{{ errorMessage }}</div>

  <!-- Session Details Form -->
  <form [formGroup]="form" class="session-form" *ngIf="isEditMode || isInsert">
    <div class="form-row">
      <div class="form-group">
        <label for="location">Location *</label>
        <input 
          type="text" 
          id="location" 
          formControlName="location" 
          placeholder="Enter location"
          [readonly]="isViewMode"
          class="form-input" />
      </div>

      <div class="form-group">
        <label for="sessionDate">Date *</label>
        <input 
          type="date" 
          id="sessionDate" 
          formControlName="sessionDate"
          [readonly]="isViewMode"
          class="form-input" />
      </div>
    </div>

    <div class="form-group">
      <label for="participants">Participants</label>
      <div class="participants-container">
        <div class="participants-list" *ngIf="participants.length > 0">
          <span *ngFor="let participant of participants" class="participant-tag">
            {{ participant }}
            <button 
              *ngIf="isEditMode || isInsert" 
              type="button" 
              class="remove-participant-btn" 
              (click)="removeParticipant(participant)"
              title="Remove participant">
              ✕
            </button>
          </span>
        </div>
        <div class="add-participant-section" *ngIf="isEditMode || isInsert">
          <input 
            type="text" 
            [(ngModel)]="newParticipant"
            [ngModelOptions]="{standalone: true}"
            placeholder="Enter participant name"
            (keyup.enter)="addParticipant()"
            class="form-input participant-input" />
          <button 
            type="button" 
            class="btn btn-secondary add-participant-btn" 
            (click)="addParticipant()"
            [disabled]="!newParticipant.trim()">
            Add
          </button>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea 
        id="description" 
        formControlName="description" 
        placeholder="Enter session description (optional)"
        [readonly]="isViewMode"
        rows="3"
        class="form-input"></textarea>
    </div>

    <div class="form-group" *ngIf="isEditMode || isInsert">
      <label for="sessionImage">Session Image</label>
      <input 
        type="file" 
        id="sessionImage" 
        accept="image/*" 
        (change)="onSessionImageSelected($event)"
        class="form-input" />
      <small class="form-help">Upload an image for this session (optional)</small>
    </div>
  </form>

  <!-- DevKit Lists -->
  <div class="devkit-lists">
    <div class="section-header">
      <div class="section-title-wrapper">
        <h3>Used Solutions</h3>
        <button *ngIf="(isEditMode || isInsert) && availableDevKits.length > 0" 
                class="add-section-btn" 
                (click)="showAddDevKitModal = true"
                title="Add DevKit">
          +
        </button>
      </div>
    </div>
    <div class="devkit-grid" *ngIf="sessionDevKits.length > 0">
      <div *ngFor="let devKitWithFilms of sessionDevKits" class="devkit-container">
        <div class="devkit-header">
          <div class="devkit-info">
            <h4>{{ devKitWithFilms.devKit.name }}</h4>
            <button 
              class="preview-btn"
              (mouseenter)="onDevKitHover(devKitWithFilms.devKit.rowKey, $event)"
              (mouseleave)="onDevKitLeave()"
              title="Preview DevKit Image">
              ?
            </button>
          </div>
          <button 
            *ngIf="isEditMode || isInsert"
            class="remove-btn" 
            (click)="removeDevKitFromSession(devKitWithFilms.devKit.rowKey)"
            title="Remove DevKit">
            ✕
          </button>
        </div>

        <!-- DevKit Image Tooltip -->
        <div 
          class="devkit-image-tooltip" 
          *ngIf="hoveredDevKit === devKitWithFilms.devKit.rowKey">
          <img [src]="devKitWithFilms.devKit.imageUrl" [alt]="devKitWithFilms.devKit.name" />
          <div class="devkit-tooltip-title">{{ devKitWithFilms.devKit.name }}</div>
          <div class="devkit-tooltip-info">
            <span>{{ devKitWithFilms.devKit.type }}</span>
            <span>{{ devKitWithFilms.devKit.filmsDeveloped }}/{{ devKitWithFilms.devKit.validForFilms }}</span>
          </div>
        </div>

        <!-- Drop Zone for Films -->
        <div 
          class="film-drop-zone"
          [cdkDropListDisabled]="isViewMode"
          cdkDropList
          [cdkDropListSortingDisabled]="true"
          [id]="'devkit-' + devKitWithFilms.devKit.rowKey"
          [cdkDropListData]="devKitWithFilms.assignedFilms"
          [cdkDropListConnectedTo]="getConnectedLists()"
          (cdkDropListDropped)="onFilmDrop($event)">
          
          <div class="drop-zone-content">
            <div 
              *ngFor="let film of devKitWithFilms.assignedFilms" 
              class="film-card removable-film"
              [cdkDragDisabled]="isViewMode"
              cdkDrag>
              <button 
                *ngIf="isEditMode || isInsert"
                class="remove-film-btn" 
                (click)="removeFilmFromSession(film.rowKey)"
                title="Remove from session">
                ✕
              </button>
              <img [src]="film.imageUrl" [alt]="film.name" class="film-image" />
              <div class="film-info">
                <span class="film-name">{{ film.name }}</span>
                <span class="film-details">{{ film.type }} - ISO {{ film.iso }}</span>
                <span class="film-owner">{{ film.purchasedBy }}</span>
              </div>
            </div>
            
            <!-- Empty state -->
            <div class="empty-drop-zone" *ngIf="devKitWithFilms.assignedFilms.length === 0">
              <p *ngIf="isEditMode || isInsert">Drop films here to assign them to {{ devKitWithFilms.devKit.name }}</p>
              <p *ngIf="isViewMode">No films assigned to {{ devKitWithFilms.devKit.name }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="empty-state" *ngIf="sessionDevKits.length === 0">
      <p *ngIf="isEditMode || isInsert">Click the '+' button above to add development solutions to this session.</p>
      <p *ngIf="isViewMode">No development solutions were used in this session.</p>
    </div>
  </div>

  <!-- Unassigned Films -->
  <div class="unassigned-films-section">
    <div class="section-header">
      <div class="section-title-wrapper">
        <h3>Developed Films</h3>
        <button *ngIf="(isEditMode || isInsert) && availableUnassignedFilms.length > 0" 
                class="add-section-btn" 
                (click)="showAddFilmModal = true"
                title="Add Film">
          +
        </button>
      </div>
    </div>
    <div 
      class="film-drop-zone unassigned-zone"
      [cdkDropListDisabled]="isViewMode"
      cdkDropList
      [cdkDropListSortingDisabled]="true"
      id="unassigned-films"
      [cdkDropListData]="unassignedFilms"
      [cdkDropListConnectedTo]="getConnectedLists()"
      (cdkDropListDropped)="onFilmDrop($event)">
      
      <div class="unassigned-grid" *ngIf="unassignedFilms.length > 0">
        <div 
          *ngFor="let film of unassignedFilms" 
          class="film-card removable-film"
          [cdkDragDisabled]="isViewMode"
          cdkDrag>
          <button 
            *ngIf="isEditMode || isInsert"
            class="remove-film-btn" 
            (click)="removeFilmFromSession(film.rowKey)"
            title="Remove from session">
            ✕
          </button>
          <img [src]="film.imageUrl" [alt]="film.name" class="film-image" />
          <div class="film-info">
            <span class="film-name">{{ film.name }}</span>
            <span class="film-details">{{ film.type }} - ISO {{ film.iso }}</span>
            <span class="film-owner">{{ film.purchasedBy }}</span>
          </div>
        </div>
      </div>
      
      <!-- Empty state -->
      <div class="empty-drop-zone" *ngIf="unassignedFilms.length === 0 && sessionDevKits.length > 0">
        <p *ngIf="isEditMode || isInsert">All films have been assigned to solutions</p>
        <p *ngIf="isViewMode">All films were assigned to solutions</p>
      </div>
      <div class="empty-drop-zone" *ngIf="unassignedFilms.length === 0 && sessionDevKits.length === 0">
        <p *ngIf="isEditMode || isInsert">Click the '+' button above to add developed films to this session.</p>
        <p *ngIf="isViewMode">No films were developed in this session.</p>
      </div>
    </div>
  </div>

  <!-- Mobile Instructions -->
  <div class="mobile-instructions">
    <p><strong>Mobile:</strong> Tap and hold to drag films between solutions</p>
  </div>
</div>

<!-- Add DevKit Modal -->
<div class="modal-overlay" *ngIf="showAddDevKitModal" (click)="closeAddDevKitModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Solution</h3>
      <button class="modal-close" (click)="closeAddDevKitModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-options">
        <label class="checkbox-option">
          <input type="checkbox" [(ngModel)]="showExpiredDevKits" />
          <span>Show expired dev kits</span>
        </label>
      </div>
      <div class="items-grid">
        <div *ngFor="let devKit of filteredAvailableDevKits" class="item-card" 
             [class.expired]="devKit.expired"
             [class.selected]="isDevKitSelectedForModal(devKit.rowKey)"
             (click)="toggleDevKitSelection(devKit.rowKey)">
          <div class="item-content">
            <div class="item-info">
              <img [src]="devKit.imageUrl" alt="{{devKit.name}}" class="item-image" />
              <div class="item-details">
                <span class="item-name">{{devKit.name}}</span>
                <span class="item-type">{{devKit.type}}</span>
                <span class="item-status" *ngIf="devKit.expired">EXPIRED</span>
              </div>
            </div>
          </div>
          <div class="item-checkbox">
            <input type="checkbox" 
                   [checked]="isDevKitSelectedForModal(devKit.rowKey)"
                   readonly />
          </div>
        </div>
      </div>
      <div class="modal-footer" *ngIf="selectedDevKitsForModal.length > 0">
        <button class="btn btn-primary" (click)="addSelectedDevKits()">
          Add {{ selectedDevKitsForModal.length }} Solution{{ selectedDevKitsForModal.length > 1 ? 's' : '' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Film Modal -->
<div class="modal-overlay" *ngIf="showAddFilmModal" (click)="closeAddFilmModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Film</h3>
      <button class="modal-close" (click)="closeAddFilmModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="items-grid">
        <div *ngFor="let film of availableUnassignedFilms" class="item-card"
             [class.selected]="isFilmSelectedForModal(film.rowKey)"
             (click)="toggleFilmSelection(film.rowKey)">
          <div class="item-content">
            <div class="item-info">
              <img [src]="film.imageUrl" alt="{{film.name}}" class="item-image" />
              <div class="item-details">
                <span class="item-name">{{film.name}}</span>
                <span class="item-type">{{film.type}} - ISO {{film.iso}}</span>
                <span class="item-owner">{{film.purchasedBy}}</span>
              </div>
            </div>
          </div>
          <div class="item-checkbox">
            <input type="checkbox" 
                   [checked]="isFilmSelectedForModal(film.rowKey)"
                   readonly />
          </div>
        </div>
      </div>
      <div class="modal-footer" *ngIf="selectedFilmsForModal.length > 0">
        <button class="btn btn-primary" (click)="addSelectedFilms()">
          Add {{ selectedFilmsForModal.length }} Film{{ selectedFilmsForModal.length > 1 ? 's' : '' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Session Image Modal -->
<div class="image-preview-overlay" *ngIf="showSessionImageModal" (click)="showSessionImageModal = false">
  <img *ngIf="currentItem.imageUrl" [src]="currentItem.imageUrl" alt="Session Image" (click)="$event.stopPropagation()" />
  <button class="close-btn" (click)="showSessionImageModal = false; $event.stopPropagation()">✖</button>
  <div *ngIf="isEditMode || isInsert" class="preview-actions" (click)="$event.stopPropagation()">
    <input type="file" accept="image/*" (change)="onSessionImageSelected($event)" #sessionImageInput style="display: none" />
    <button class="preview-action-btn" (click)="sessionImageInput.click(); $event.stopPropagation()">
      Choose New Image
    </button>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="loading-spinner"></div>
  <p>Loading session data...</p>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-modal-overlay" *ngIf="isDeleteModalOpen" (click)="isDeleteModalOpen = false">
  <div class="delete-modal" (click)="$event.stopPropagation()">
    <h2>Confirm Delete</h2>
    <p *ngIf="currentItem">
      Are you sure you want to delete this session at <strong>{{ currentItem.location }}</strong> 
      on <strong>{{ currentItem.sessionDate | date:'mediumDate' }}</strong>?
    </p>
    <div class="side-effects">
      <h3>⚠️ Side Effects:</h3>
      <ul>
        <li><strong>{{ getTotalFilmsCount() }}</strong> film(s) will be marked as <strong>not developed</strong></li>
        <li>Film references to this session will be <strong>cleared</strong></li>
        <li>DevKit film counts will be <strong>decremented</strong></li>
        <li>Session image will be <strong>permanently deleted</strong></li>
        <li>This action <strong>cannot be undone</strong></li>
      </ul>
    </div>
    <div class="delete-modal-actions">
      <button class="cancel-btn" (click)="isDeleteModalOpen = false">Cancel</button>
      <button class="delete-confirm-btn" (click)="onDelete()">Delete Session</button>
    </div>
  </div>
</div>