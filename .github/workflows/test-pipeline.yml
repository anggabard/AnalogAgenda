name: Test Pipeline

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Build test projects
      run: |
        dotnet build Tests/AnalogAgenda.Server.Tests/AnalogAgenda.Server.Tests.csproj
      shell: pwsh
      
    - name: Run AnalogAgenda.Server tests (includes Database tests)
      run: dotnet test Tests/AnalogAgenda.Server.Tests/AnalogAgenda.Server.Tests.csproj --no-build --verbosity normal --logger trx --results-directory TestResults
      shell: pwsh
        
    - name: Upload backend test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results
        path: TestResults/*.trx

  test-frontend:
    name: Frontend Tests
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: analogagenda.client/package-lock.json
      
    - name: Install dependencies
      working-directory: ./analogagenda.client
      run: npm ci
      
    - name: Run frontend tests
      working-directory: ./analogagenda.client
      run: npx ng test --watch=false --browsers=ChromeHeadless --code-coverage
        
    - name: Upload frontend test coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-coverage
        path: analogagenda.client/coverage/

  test-summary:
    name: Test Summary
    needs: [test-backend, test-frontend]
    runs-on: windows-latest
    if: always()
    
    steps:
    - name: Test Results Summary
      if: needs.test-backend.result == 'success' && needs.test-frontend.result == 'success'
      shell: pwsh
      run: |
        "## ‚úÖ Test Results Summary" | Add-Content $env:GITHUB_STEP_SUMMARY
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "### All Tests Complete" | Add-Content $env:GITHUB_STEP_SUMMARY
        "‚úÖ Frontend and backend tests executed successfully" | Add-Content $env:GITHUB_STEP_SUMMARY
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "### Coverage Reports" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üìä Frontend coverage available in artifacts" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üìã Backend test results available in artifacts" | Add-Content $env:GITHUB_STEP_SUMMARY
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üéâ All tests passed!" | Add-Content $env:GITHUB_STEP_SUMMARY
        
    - name: Test Failure Summary
      if: needs.test-backend.result != 'success' || needs.test-frontend.result != 'success'
      shell: pwsh
      run: |
        "## ‚ùå Test Failure Summary" | Add-Content $env:GITHUB_STEP_SUMMARY
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "### Tests Failed" | Add-Content $env:GITHUB_STEP_SUMMARY
        if (needs.test-backend.result != 'success') { "‚ùå Backend tests failed" | Add-Content $env:GITHUB_STEP_SUMMARY }
        if (needs.test-frontend.result != 'success') { "‚ùå Frontend tests failed" | Add-Content $env:GITHUB_STEP_SUMMARY }
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "### Debugging Resources" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üìã Backend test results (if available) can be found in the artifacts section" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üìä Frontend coverage (if available) can be found in the artifacts section" | Add-Content $env:GITHUB_STEP_SUMMARY
        "" | Add-Content $env:GITHUB_STEP_SUMMARY
        "üîç Review the individual test job logs above to identify which tests failed and why." | Add-Content $env:GITHUB_STEP_SUMMARY
